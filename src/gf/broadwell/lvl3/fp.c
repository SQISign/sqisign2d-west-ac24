#include "include/fp.h"

// TODO should we modify fp_sqrt to take an out
// variable?
void 
fp_sqrt(fp_t * x)
{
    (void)gf65376_sqrt(x, x);
}

bool
fp_is_square(const fp_t * a)
{
    return -1 != gf65376_legendre(a);
}

// TODO should we modify fp_inv to take an out
// variable?
void
fp_inv(fp_t * x)
{
    (void)gf65376_invert(x, x);
}

/*
CAUTION: HAZARDOUS MATERIALS

The following tables are constants used for torsion basis generation. All values have already been converted into Montgomery
form, and so if the internal API for the field changes, these values may also need to change

NQR_TABLE:
    is a table of 20 values all of which are not squares in GF(p^2) with modulus x^2 + 1 and prime p = 65*2**376 - 1
Z_NQR_TABLE:
    is a table of 20 values for which the value is a square and (value - 1) is not a square in the field GF(p^2) 
    with modulus x^2 + 1 and prime p = 65*2**376 - 1 
*/

const uint64_t NQR_TABLE[20][2][NWORDS_FIELD] = {
    {{0x0B8A7D5D45C5F8DD, 0x8939E9E370EEAC88, 0x6E8358DCD96B15B4, 0x64856364170F7CD2, 0xCDC311CFEBBC2186, 0x233B37E2750E4E56},
     {0x7AACDF7F9E5967BF, 0x19DF123DA188E177, 0x0121B461D3E1687F, 0xE3C42E8B5FA6D3CE, 0x73F14F10C2833861, 0x3CCA66F1B303B9CF}},
    {{0x48A7D015A91C0E99, 0xBAA1780A47A605DA, 0xA4F721D9BF0F8461, 0x11A72B3BBE77D418, 0x949E0B123504078A, 0x133E7184C1011250},
     {0x80E50BDF27C09F23, 0x0A2EE8C5F580B065, 0xFDF5094C4A222E5E, 0x608DC44C7FC3DB42, 0x544318E917CC7776, 0x31BB0AC87CC883BF}},
    {{0x931B9E980140DDA9, 0xA8F253F28A81F592, 0xEAA9EAB69D27D153, 0xD9878191CDF4B5CC, 0x8A683C26F2BF72AE, 0x033EE57054442ED1},
     {0xB2C0CDE226869C72, 0x437550D54E0E79D3, 0x473F891570848DB3, 0xC9BA58D168B8BD5D, 0x37AE358DFBE71BE0, 0x2DC173298165B78F}},
    {{0xAD9F07535FE10ACA, 0x4B1FAFB223D09154, 0xC828EC64FE13226B, 0xAA609BBF9FE375EA, 0x74509B1E54DEF252, 0x2A0034BB4B19F5E6},
     {0x5CBD5028741814A1, 0xBCECB0445862EA09, 0x35A8AA39D62B4FAB, 0xF78D1CB28D9F001B, 0x48D1C6B5A2C02F8E, 0x0E7B374C2E660B75}},
    {{0x4DBC38719D7C2671, 0xEB5A60B03334DB21, 0x6DADB4876D0F6F61, 0x7FF4A157DD7B0F15, 0x22D94CFAB704CEE2, 0x33F24B006E7A08D3},
     {0x301DA19C76EC1DE2, 0x34B542C2A764BFC9, 0xFFA41157D859BB56, 0xF25B58BAB8886EC3, 0x7363F9A2D69DE03C, 0x08ACC2CE7877F58D}},
    {{0x1A023AC8B77A4AFD, 0xC84EFDB313C5E981, 0x3387D4DA91FBF5E0, 0x7C5340670EDF7D52, 0xD686D99928F35BCA, 0x1C8E4B8D40D24F4A},
     {0x8BE91ECFAA82DD5B, 0xF9ADCFE61F0621C2, 0x7DF0EEB57620C11C, 0xB106454C75F588A6, 0x355985C31606C81C, 0x1F41AF4A6F4FB35E}},
    {{0x0A629A2A738F8DB7, 0x652DAF79F25C4DD5, 0x8FE34B26C7F425E1, 0x15978662D386354B, 0x99B6FD2417BFC93B, 0x05F693E1723A06AB},
     {0x7E2E76526C1F74AF, 0xBF114F425EA28692, 0xC50FE026D11A7E2B, 0x5D692BD02797A2B6, 0xE87205380DF232D1, 0x13C64788505AEC5C}},
    {{0x6C381A8F2C64F2D4, 0xD68DC22ECFBCCE86, 0x43CCA39D3617AC8B, 0x07B9AB93DB22D64D, 0x52F833EA9771D591, 0x3041E1C85C060EC6},
     {0x154C34D93A780943, 0xC577182D7A1A3F39, 0x97BBB1DDE4223315, 0x3E97CEFFF7A14C74, 0xCA4886FF2663E6CB, 0x39DA89458EF6095F}},
    {{0xCD185A78F28E0865, 0x5C01EA881AA51532, 0xAE5FA1EC653788A6, 0x5117C59B740DE73E, 0x299075BCBD03C5B0, 0x3402BE0D1DAB811D},
     {0x0BA92FE0A1C2358E, 0xEB8D83F05607AFEA, 0xEAC965C5DA47393A, 0x603A931B78B6118A, 0x728285A94443CF6C, 0x19C264B7882019FA}},
    {{0x8EA5D815731FB83E, 0x629482C70D0B018E, 0x9C5173639E43E69E, 0x91D80E4BAA3A7239, 0xF87F0CC21F91D7E7, 0x1294BE15665511CF},
     {0x25E8FE32D2853C10, 0xCFF73A3C56453946, 0x54F73249019E9F05, 0x342A74E38E242028, 0xB68FBE84F8C93FE8, 0x2ECDA5C49E7AFB3D}},
    {{0x6A56D457E1936E41, 0x41894EC59FC64793, 0xD7948B38B70A6736, 0xCA51F0BB20124662, 0xE279ADFA5AFE1210, 0x1C54C2AC1BDC4A2E},
     {0xA02BA70AA0EB0D35, 0x92AC277A9D231EE0, 0x5520FE67A8AA56C9, 0x687294E219678C0E, 0x7D14BD23D8F015CF, 0x1B3C387AC48D0C63}},
    {{0xC25C64ED4B90B2EB, 0x14D069263AC0DDF2, 0x1E4BBB8CDD7C71B3, 0x4DC44C3D9EEF4EBC, 0xCB73BD56C8186256, 0x18D2AEC34ED19BF3},
     {0xC2A27B511120D178, 0x5F188AE59D132E98, 0xDBA673A35FA43630, 0xC6FB10DFCD144EA9, 0xEB7C2160B11B34FC, 0x12FE446DDDADDF68}},
    {{0x758F6D92DE5B26F8, 0x06E6FD9B4ABDBBDD, 0x10AD0A54DEF5BEE9, 0xEC216B738BCBF5EC, 0xC56A94824F9C6258, 0x3F0FDAC3F657DBC2},
     {0x437FAF5B62F1D431, 0x98312C9DEB37A272, 0x08FC789D4B3A1DD5, 0x5622DFB5BEC379B0, 0xD596693C34E72729, 0x2BF0A097C02376DA}},
    {{0x93319ACFF87C0165, 0x50BFE50A66885688, 0xB4EA200D542B59DB, 0xF5C0379001A0DB36, 0xB46180A1C078669D, 0x399192EA4D904CB7},
     {0x4D485E696CD7EB85, 0x61A39978D7A75D76, 0x92B56067BA7E5330, 0x15A7CE75E0368AFF, 0xDC00D3AFBF2EE521, 0x15CFED5B489DF7A5}},
    {{0x6E9CFDB1A986D82E, 0xDBA0622FD1697E36, 0x56647F36CBAA6BA2, 0x2CA177E4ACC52D37, 0xE2A7FD2B155D665A, 0x293473DE5CF578AF},
     {0x7BBC2311CF06AA9E, 0xD443FD24A23BBC24, 0x352D605B914396FE, 0x1F8EED5B6EE2A25A, 0xF3DB0FB68A3D1321, 0x261B3FCC94DC99D9}},
    {{0xC323BD94EEB83D45, 0x16A934AE50BC8DCE, 0x82EFDE6777DE0748, 0xF09D7ADB8478A8C7, 0xB8B638077CAB8C27, 0x09A2D31F1D57AD01},
     {0x466A883DB686BCE6, 0xD7CBD87BB4D7FB6B, 0x71815EC5F3D7F039, 0xBCAAEF34BCBF5EC3, 0x5CEF41DF6835C810, 0x3DEB07CCF1DA5BF6}},
    {{0x28B0D4596C15F46C, 0x1052893D7678F3FB, 0x9734A2D51AAB8C0C, 0x16B590445BA3DF9A, 0xA1B72D906622C35F, 0x10C10E44303F7BDB},
     {0x4BA4D8C14904A72E, 0x996FCDC652F09BAF, 0xB843CF86BF2EA5DE, 0x396099A41C518E6E, 0x422540497C32F852, 0x1F17549F31014A62}},
    {{0xC2B28BDB7E7EB93A, 0x7A601799E8F6F913, 0x0CBFE7F65980E63A, 0x940BCB18A3803719, 0x8D55FBB92AB4CA3D, 0x260FB47F39106DDF},
     {0x1276221D2BE6CA01, 0x95BDF2B31BFFFD5E, 0x6B956DCD5CBFE7A4, 0xB941140182DAD058, 0x8B43CFF3DBA5DBA2, 0x0A0FDEEFB40A2416}},
    {{0xA75D96C720E13A08, 0x19720602491CFF0D, 0x3100A8E4023F405B, 0x2D5E5DEDE8BD65D6, 0xF7647252DC286AED, 0x2892C34D9FCF31F2},
     {0x3109208018DF2D13, 0xDD46DE44555FA013, 0x979464EBF39C5B63, 0x18B9EB54B27C107A, 0x9B71B84858C4BEED, 0x19D47DA181528CDE}},
    {{0xB950610476642B86, 0xEDBABC47CD214910, 0x8FC3E82B4709FB49, 0x53DB1B3ADFFA8C93, 0xDC0AB467AA3430F2, 0x25AEDDDF63051266},
     {0x6A3453A391E4893A, 0xDBC60AD88CB8C595, 0xE49D921D45000AF4, 0x250A14B9653EDD4A, 0xE8A22E68055EC80D, 0x375FF02F962A3D69}},
};

const uint64_t Z_NQR_TABLE[20][2][NWORDS_FIELD] = {
    {{0x6B8D528CC204316C, 0xEDC1A6B74657F567, 0x0739C055D1296C55, 0xBB6CC3C09E232F9D, 0xD689E09567FC22E6, 0x271D18AC3AE9A30D},
     {0x14D6B37721CF0A56, 0xEC111CAA83FBFA54, 0x91696BEAD6C72EAF, 0x6798E8BDDBBF5C5F, 0x613335DA65B4CE21, 0x04C0084217FF2473}},
    {{0xB75C3741D967DAC3, 0x68CE0E1ACEE7D952, 0x3AC9D0A231692B26, 0x4968364C37E40002, 0x9B6A375B1A12EDE0, 0x040FFE219186BEAC},
     {0xFF21BC5B97E1AA07, 0xBCD53A3291E9260F, 0x289B1BFD807A20B1, 0xB8442444CEED889B, 0x926C60DA3C776133, 0x0D78DE2CFC6FCBDF}},
    {{0xE335EA9EB4911BCD, 0xF72B96E21C0BC3F3, 0x7A2BC8C4FE7D7730, 0xC93260353680E536, 0xFAF0EEDA8A14C0EF, 0x196F752A0232E259},
     {0x3011646FCE737B85, 0x9EEFD703DC593F3E, 0xDCF63DC540BF9D50, 0x2F9E4793C557E628, 0x6984E6470A195CCC, 0x3686D186D6C599D8}},
    {{0x297C36436359023A, 0xB8B24260550EE6CA, 0x6824B9DD263F3A34, 0x08BCB1CB72762CC6, 0x28DBF8045F78500C, 0x2A49650715A9ACC7},
     {0x4BA64110D9909E99, 0x79968655F3E7CE5B, 0x243DC7C446B2036A, 0x853B0B1111814031, 0x4439BEB9B7A21BFE, 0x1B626DFA06AF79CD}},
    {{0x798D7E4568F7C31B, 0x4698DEA99579B12B, 0x1D8F82F58D9E1BB6, 0x5DE021C76A408AD8, 0xB9C3B97C3B74910C, 0x2E49EC2E029BF924},
     {0x138A8DAAF8E7C572, 0x0CCCC11070B345D6, 0x825B391B50D5CE06, 0x58608EE1F4AECCBC, 0xC50CC92434A94CEA, 0x159626350FAFBB99}},
    {{0x9CA4552328EBC6CA, 0x190C1D4DE9DE9AA8, 0x9FFF98824E882817, 0xFD38AF551B2CF6D6, 0x553863E9F45FCA4B, 0x1C4C1DD6743E8F0E},
     {0x23BA5727856AD99B, 0x5AB4C13C27A64714, 0x9A403FE9CE0674EF, 0xB39751E4933BB451, 0x732435BD28972164, 0x14B16AD56F2D37F3}},
    {{0xAE4236E91BB59C1D, 0x0CD116A44DDD244C, 0x4E0E73369364206C, 0x7A248B9C54720847, 0xE7DB37590A8A606E, 0x3AB2433122B83179},
     {0xB4065DB728D62825, 0x84955B63C3708267, 0xD37F2F301FBFFD56, 0x842D7C4F2E34F9FC, 0x23F122CA5FE93BAF, 0x2215482EB0746252}},
    {{0xD299B6692F7E8964, 0xEBECF3B46976BDE1, 0x4CF8FD20739E6D1C, 0xB3FDAEFA8AA914C7, 0x957124F920F922D5, 0x3CB912C6692C5D59},
     {0x041928BE9CAE7EF4, 0x5A3139BE944C87EF, 0x6FDFD73B1CC5B1E4, 0xECAA06528E2E13A8, 0x47DFA442783B95FE, 0x3E8731CEACC22516}},
    {{0x29C531919B8F562E, 0xE66EED074E5A9308, 0x7F7687854CC8DA59, 0x80D9D118B55B8F3E, 0x0B3AF14417C2F12C, 0x407889560470AA42},
     {0xDEC3C04053F0A1CB, 0xA43CD450883B15F1, 0x3B6AA597E39CEE0E, 0xA64CEC5E1E231458, 0x0C99236E3C95A5B5, 0x3FCB589DB9C15B8E}},
    {{0xDF34854667795C91, 0x33059799106FB6C1, 0xEBC4EEBA30D779E5, 0x764DEF86FEC6868D, 0xC7763066220AC887, 0x383C4278A976B9A2},
     {0xCE67DCCE6F7A787D, 0x66C9B8DFFE2907B4, 0xB858806458DFC45D, 0x9CCB8B7A75FF829A, 0x0E54D4CFE24110A0, 0x3C37C79AEC0AB9EE}},
    {{0x066CA749FADC4294, 0x75FBA410E68F5A78, 0x943E1AB10B067B16, 0xAAB629C585F725B4, 0x00DE21767AA77D23, 0x23BC58BB664534AE},
     {0xA9472D5332837D77, 0x641E568C2B7E566A, 0x24120D2608995794, 0xEE9F025349D9D08C, 0x258E5D43352AE104, 0x09F070F7D4BBADD2}},
    {{0xE83B91B68B6A562E, 0x6E44257E69292096, 0x322A3E0B5E551B69, 0xFDE16A494A3A5780, 0x483363FC67FE3E58, 0x1C5BED571A2660F2},
     {0xF7C629A307A10233, 0xA1BEB5DDDFDA2986, 0x5424CE0A94239E56, 0x7FEF18BF7232665D, 0x214CEB73E5A9D86A, 0x1098D47EA981BD55}},
    {{0xE590D647B4DDC67D, 0x2DBA58C45DC28BCE, 0xEB52454AE15951AF, 0xBB9FEB00915D702E, 0x38ECDD88395D8899, 0x0A234C3D9FE04956},
     {0x42A927F1A83D44EC, 0x72D3B01E5012CD0B, 0xEF8D62DB3673EA26, 0x5BA8BE0739E080C2, 0x6D09DF4EAF39D25C, 0x3A5D3CB567F6F965}},
    {{0xDE460FEC6B9A2285, 0x9C016F1AFA6249B6, 0x0D89B5F473073E4D, 0x47518B7A2F00A817, 0x967C85BF53397F9B, 0x0DA92A10E413089E},
     {0x3B2E7D603DDEF8A1, 0x75ED495DA0734B31, 0x8B21C2623B1ED7BE, 0x32125288103FBDF3, 0x43645D4328BEA360, 0x07DD932301A8C0C5}},
    {{0x89F9A90C01E6D32E, 0x0C59E2D0044F8C0A, 0x4D81E1B92A5E2919, 0x916318520AE03859, 0x37D4BA44801D6315, 0x1CD5B1577DAB788E},
     {0x80E27C24BF9C0C71, 0xB7509FD06519900D, 0xB4ABC3504491B93D, 0xCFDB7D784EDCC59B, 0x1218B6A941104153, 0x220B23E58BA4A6E9}},
    {{0xBD45E63893688380, 0xA123BC8C12F54F6C, 0x5B9B4FE35196B327, 0x55C01A82FF8BEF79, 0x7AF8EB5A95F15C06, 0x342FE2A3AAA0DBA4},
     {0x4BB7119BF134FD45, 0x681B1CAF70D2AE1D, 0x057E8610DC5D0451, 0x8BA1431F1CB47C74, 0x36247E2932626A5A, 0x3694B0A7AD0C5D42}},
    {{0x263FC06629A0B37D, 0x3DBBD36DF2DABC3F, 0x3B3F3B4300F84B19, 0x0B4E8F35FC7CBFC8, 0xD16D92D89D73B027, 0x0993C8FF274CC2BC},
     {0xC6CDC62FB6A6BDCE, 0xEAF0CE37A6C75C4C, 0xAFBEE73DD077CED1, 0x07AC28F2C1DB66BC, 0xA2DD994D6AF78B9C, 0x3B562CA924B95C73}},
    {{0x9CF7DA77FE4E58FD, 0xF356516FCD7EF731, 0x4C7E190D8FD34838, 0xB24A5E36DD68611B, 0xFC4B6D306C334FE6, 0x1FCE2FEC399ADF59},
     {0xD43BD6BC8E5568EA, 0x6773490E6114EB0B, 0xFE8FA7F973B68A78, 0xCCF549A6176843C3, 0x035761725BACCDDA, 0x04307D03C8C2CA61}},
    {{0x54704130F8FC9E2A, 0xB0A63799FC39B652, 0x137B3887B9F1467C, 0x88583A83ACA156A4, 0xE76C516675F943C3, 0x3690A083338960D4},
     {0x84B5C89448B429FD, 0x85864523E258CAE7, 0x02C71E479D2536EF, 0x3EE093E8C8320B83, 0x2FED76003B01B4D1, 0x35A347A3C92F851C}},
    {{0xE72AB099D0AEA4A6, 0xC9068C207E5D3AB7, 0x3D05EC7A66FC6580, 0x88896D7E0B7875A4, 0x0424DFE48E5E09DE, 0x0CE8BB541F8E92F1},
     {0x8C12764DA0E27DAC, 0xB9CFF8AA814B5CA4, 0x761F0413B59C8DE0, 0x933510C79256B4F0, 0xC5E0AC289D94D27D, 0x01F0CB22089ADCF2}},
};
